<!-- micro_cold_spray/ui/templates/base.html -->
<!DOCTYPE html>
<html>
<head>
    <title>MicroColdSpray Control System</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
        // API URLs injected from backend
        const API_URLS = {{ api_urls | tojson | safe }};
        const WS_URLS = {{ ws_urls | tojson | safe }};

        // Improved WebSocket connection function with reconnection
        function connectWebSocket(url, onMessage) {
            let ws = null;
            let reconnectAttempts = 0;
            const MAX_RECONNECT_ATTEMPTS = 5;
            const RECONNECT_DELAY = 1000;

            function connect() {
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    console.log(`Connected to ${url}`);
                    reconnectAttempts = 0;
                };

                ws.onmessage = onMessage;
                
                ws.onclose = () => {
                    console.log(`Disconnected from ${url}`);
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        setTimeout(connect, RECONNECT_DELAY * reconnectAttempts);
                    } else {
                        showError(`Failed to connect to ${url} after ${MAX_RECONNECT_ATTEMPTS} attempts`);
                    }
                };

                ws.onerror = (error) => {
                    console.error(`WebSocket error: ${error}`);
                    ws.close();
                };
            }

            connect();
            return ws;
        }

        // Common notification functions
        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
    </script>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <h1>MicroColdSpray</h1>
        </div>
        <ul class="nav-links">
            <li class="nav-section">
                <h3>Communication</h3>
                <ul>
                    <li><a href="/communication/motion">Motion Control</a></li>
                    <li><a href="/communication/equipment">Equipment Control</a></li>
                    <li><a href="/communication/tags">Tag Monitor</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <h3>Process</h3>
                <ul>
                    <li><a href="/process/parameters">Parameters</a></li>
                    <li><a href="/process/patterns">Pattern Editor</a></li>
                    <li><a href="/process/sequences">Sequence Control</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <h3>Configuration</h3>
                <ul>
                    <li><a href="/config/editor">Config Editor</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <h3>Monitoring</h3>
                <ul>
                    <li><a href="/state/monitor">System State</a></li>
                    <li><a href="/monitoring/services">Services</a></li>
                </ul>
            </li>
        </ul>
    </nav>
    <main class="content">
        {% block content %}{% endblock %}
    </main>
</body>
</html>