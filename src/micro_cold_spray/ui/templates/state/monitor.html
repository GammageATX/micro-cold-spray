{% extends "base.html" %}
{% block content %}
<div class="panel">
    <h2>System State Monitor</h2>
    <div class="control-group">
        <h3>Current State</h3>
        <div id="current-state" class="state-display">
            <div class="state-name">Loading...</div>
            <div class="state-details"></div>
            <div class="state-actions"></div>
        </div>
    </div>

    <div class="control-group">
        <h3>State History</h3>
        <div id="state-history"></div>
    </div>

    <div class="control-group">
        <h3>State Conditions</h3>
        <div id="state-conditions"></div>
    </div>
</div>

<script>
let currentState = null;
let validTransitions = {};

// Load initial state data
async function loadStateData() {
    try {
        // Get current state
        const statusResponse = await fetch(`${API_URLS.state}/state`);
        const statusData = await statusResponse.json();
        updateCurrentState(statusData);

        // Get valid transitions
        const transitionsResponse = await fetch(`${API_URLS.state}/transitions`);
        validTransitions = await transitionsResponse.json();
        updateStateActions();

        // Get state history
        const historyResponse = await fetch(`${API_URLS.state}/history`);
        const historyData = await historyResponse.json();
        updateStateHistory(historyData);

        // Get current conditions
        await updateStateConditions();
    } catch (error) {
        console.error('Failed to load state data:', error);
        showError('Failed to load state data');
    }
}

// Update current state display
function updateCurrentState(data) {
    currentState = data.state;
    const stateDisplay = document.getElementById('current-state');
    stateDisplay.querySelector('.state-name').innerHTML = `
        <span class="state-badge ${data.state.toLowerCase()}">${data.state}</span>
    `;
    stateDisplay.querySelector('.state-details').innerHTML = `
        <div class="detail-item">
            <span class="label">Since:</span>
            <span class="value">${new Date(data.timestamp).toLocaleString()}</span>
        </div>
    `;
    updateStateActions();
}

// Update available state actions
function updateStateActions() {
    if (!currentState || !validTransitions) return;

    const validStates = validTransitions[currentState] || [];
    const actionsDiv = document.getElementById('current-state').querySelector('.state-actions');
    
    if (validStates.length === 0) {
        actionsDiv.innerHTML = '<div class="no-actions">No valid transitions available</div>';
        return;
    }

    actionsDiv.innerHTML = `
        <div class="action-buttons">
            ${validStates.map(state => `
                <button onclick="requestStateTransition('${state}')" class="state-button ${state.toLowerCase()}">
                    ${state}
                </button>
            `).join('')}
        </div>
    `;
}

// Update state history display
function updateStateHistory(history) {
    const historyDiv = document.getElementById('state-history');
    if (!history || history.length === 0) {
        historyDiv.innerHTML = '<div class="no-history">No state transitions recorded</div>';
        return;
    }

    historyDiv.innerHTML = history.map(entry => `
        <div class="history-entry">
            <div class="transition">
                <span class="state-badge ${entry.old_state.toLowerCase()}">${entry.old_state}</span>
                <i class="fas fa-arrow-right"></i>
                <span class="state-badge ${entry.new_state.toLowerCase()}">${entry.new_state}</span>
            </div>
            <div class="transition-details">
                <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
                ${entry.reason ? `<div class="reason">${entry.reason}</div>` : ''}
            </div>
        </div>
    `).join('');
}

// Update state conditions
async function updateStateConditions() {
    try {
        const response = await fetch(`${API_URLS.state}/state/conditions`);
        const data = await response.json();
        
        const conditionsDiv = document.getElementById('state-conditions');
        conditionsDiv.innerHTML = Object.entries(data.conditions).map(([name, met]) => `
            <div class="condition-item">
                <span class="condition-name">${name}</span>
                <span class="condition-status ${met ? 'met' : 'unmet'}">
                    ${met ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                </span>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to update conditions:', error);
    }
}

// Request state transition
async function requestStateTransition(targetState) {
    try {
        const response = await fetch(`${API_URLS.state}/transition`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                target_state: targetState
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail?.message || 'Transition failed');
        }

        // Refresh state data after transition
        await loadStateData();
    } catch (error) {
        console.error('Failed to transition state:', error);
        showError(error.message || 'Failed to transition state');
    }
}

// Setup periodic updates
function startUpdates() {
    // Update conditions every 5 seconds
    setInterval(updateStateConditions, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadStateData();
    startUpdates();
});

// Add styles
const style = document.createElement('style');
style.textContent = `
.state-display {
    background: var(--panel-bg);
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.state-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-weight: bold;
    text-transform: uppercase;
    color: white;
}

.state-badge.init { background: #6c757d; }
.state-badge.idle { background: #17a2b8; }
.state-badge.ready { background: #28a745; }
.state-badge.running { background: #007bff; }
.state-badge.error { background: #dc3545; }
.state-badge.shutdown { background: #343a40; }

.detail-item {
    margin: 0.5rem 0;
    display: flex;
    align-items: center;
}

.detail-item .label {
    font-weight: bold;
    margin-right: 0.5rem;
    min-width: 80px;
}

.action-buttons {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.state-button {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    text-transform: uppercase;
    color: white;
    transition: opacity 0.2s;
}

.state-button:hover {
    opacity: 0.8;
}

.history-entry {
    background: var(--panel-bg);
    padding: 0.75rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.transition {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.transition i {
    color: var(--text-color);
}

.transition-details {
    margin-top: 0.5rem;
    font-size: 0.9em;
    color: var(--text-muted);
}

.condition-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: var(--panel-bg);
    margin-bottom: 0.25rem;
    border-radius: 4px;
}

.condition-status {
    font-weight: bold;
}

.condition-status.met {
    color: #28a745;
}

.condition-status.unmet {
    color: #dc3545;
}

.no-history, .no-actions {
    color: var(--text-muted);
    font-style: italic;
    text-align: center;
    padding: 1rem;
}
`;
document.head.appendChild(style);
</script>
{% endblock %}