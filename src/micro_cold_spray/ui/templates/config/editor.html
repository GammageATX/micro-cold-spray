{% extends "base.html" %}

{% block content %}
<div class="panel">
    <h2>Configuration Editor</h2>
    <div class="control-group">
        <h3>Config Type</h3>
        <select id="config-type" onchange="loadConfig()">
            <!-- Config types loaded dynamically -->
        </select>
    </div>

    <div class="control-group">
        <h3>Editor</h3>
        <div class="editor-controls">
            <button onclick="reloadFromFile()">Reload from File</button>
            <button onclick="saveToFile()">Save to File</button>
            <button onclick="clearCache()">Clear Cache</button>
        </div>
        <textarea id="config-editor" class="json-editor"></textarea>
    </div>
</div>

<script>
async function loadConfigTypes() {
    try {
        const response = await fetch(`${API_URLS.config}/config/types`);
        if (!response.ok) throw await response.json();
        const types = await response.json();
        const select = document.getElementById('config-type');
        select.innerHTML = types.map(type => 
            `<option value="${type.id}">${type.name}</option>`
        ).join('');
        await loadConfig();
    } catch (error) {
        showError(error.detail?.error || error.detail || 'Failed to load config types');
    }
}

async function loadConfig() {
    const configType = document.getElementById('config-type').value;
    const editor = document.getElementById('config-editor');
    try {
        editor.disabled = true;
        const response = await fetch(`${API_URLS.config}/config/${configType}`);
        if (!response.ok) throw await response.json();
        const config = await response.json();
        editor.value = JSON.stringify(config.config, null, 2);
    } catch (error) {
        showError(error.detail?.error || error.detail || 'Failed to load configuration');
        editor.value = '{}';  // Set empty object on error
    } finally {
        editor.disabled = false;
    }
}

async function saveToFile() {
    const configType = document.getElementById('config-type').value;
    const editor = document.getElementById('config-editor');
    try {
        const config = JSON.parse(editor.value);
        const response = await fetch(`${API_URLS.config}/config/${configType}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        if (!response.ok) throw await response.json();
        showSuccess('Configuration saved successfully');
    } catch (error) {
        showError(error.detail?.error || error.detail || 'Failed to save configuration');
    }
}

async function reloadFromFile() {
    const configType = document.getElementById('config-type').value;
    try {
        await loadConfig();
        showSuccess('Configuration reloaded successfully');
    } catch (error) {
        showError(error.detail?.error || error.detail || 'Failed to reload configuration');
    }
}

async function clearCache() {
    try {
        const response = await fetch(`${API_URLS.config}/config/cache/clear`, {
            method: 'POST'
        });
        if (!response.ok) throw await response.json();
        showSuccess('Cache cleared successfully');
        await loadConfig();
    } catch (error) {
        showError(error.detail?.error || error.detail || 'Failed to clear cache');
    }
}

// Load config types and initial config
loadConfigTypes();
</script>
{% endblock %}