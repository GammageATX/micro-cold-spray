<!-- service_ui/templates/base.html -->
<!DOCTYPE html>
<html>
<head>
    <title>MicroColdSpray Service UI</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
    <script>
        // API URLs for all services
        const API_URLS = {{ api_urls | tojson | safe }};

        // Common WebSocket connection function
        function connectWebSocket(url, onMessage) {
            const ws = new WebSocket(url.replace('http', 'ws'));
            ws.onmessage = onMessage;
            ws.onerror = (error) => console.error('WebSocket error:', error);
            ws.onclose = () => {
                console.log('WebSocket closed, attempting reconnect...');
                setTimeout(() => connectWebSocket(url, onMessage), 5000);
            };
            return ws;
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        // Service status monitoring
        async function checkServiceStatus(service, url) {
            try {
                const response = await fetch(`${url}/health`);
                const data = await response.json();
                return {
                    name: service,
                    status: response.ok ? 'online' : 'offline',
                    details: data
                };
            } catch (error) {
                return {
                    name: service,
                    status: 'offline',
                    error: error.message
                };
            }
        }

        async function updateServiceStatuses() {
            const statusContainer = document.getElementById('service-status');
            if (!statusContainer) return;

            for (const [service, url] of Object.entries(API_URLS)) {
                const status = await checkServiceStatus(service, url);
                const statusElement = document.getElementById(`${service}-status`);
                if (statusElement) {
                    statusElement.className = `service-status ${status.status}`;
                    statusElement.innerHTML = `
                        <div class="status-indicator ${status.status}"></div>
                        <div class="status-name">${service}</div>
                        <div class="status-details">
                            ${status.status === 'online' 
                                ? `Version: ${status.details?.version || 'N/A'}`
                                : `Error: ${status.error || 'Service unreachable'}`}
                        </div>
                    `;
                }
            }
            setTimeout(updateServiceStatuses, 5000);
        }

        // Start monitoring on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('service-status')) {
                updateServiceStatuses();
            }
        });
    </script>
</head>
<body>
    <nav>
        <div class="nav-group">
            <h3>Communication</h3>
            <a href="/communication/motion">Motion Control</a>
            <a href="/communication/equipment">Equipment Control</a>
            <a href="/communication/tags">Tag Monitor</a>
        </div>
        <div class="nav-group">
            <h3>Process</h3>
            <a href="/process/parameters">Parameters</a>
            <a href="/process/patterns">Pattern Editor</a>
            <a href="/process/sequences">Sequences</a>
        </div>
        <div class="nav-group">
            <h3>System</h3>
            <a href="/config/editor">Config Editor</a>
            <a href="/state/monitor">State Monitor</a>
        </div>
    </nav>

    <main>
        {% if request.url.path == "/" %}
        <div class="panel">
            <h2>Service Status</h2>
            <div id="service-status" class="service-grid">
                {% for service in api_urls %}
                <div id="{{ service }}-status" class="service-status offline">
                    <div class="status-indicator offline"></div>
                    <div class="status-name">{{ service }}</div>
                    <div class="status-details">Checking status...</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>
</body>
</html>